<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>База подарков Telegram</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html, body {
            height: 100%;
            overflow-x: hidden;
        }
        
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'SF Pro Display', sans-serif;
            background: var(--tg-theme-bg-color, #0a0a0a);
            color: var(--tg-theme-text-color, #ffffff);
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
            line-height: 1.5;
        }
        
        #root {
            min-height: 100vh;
            width: 100%;
            position: relative;
        }
        
        .telegram-app {
            min-height: 100vh;
            background: linear-gradient(180deg, #0a0a0a 0%, #1a1a2e 100%);
            position: relative;
        }
        
        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .spin {
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .6; }
        }
        
        .glow {
            box-shadow: 0 0 20px rgba(82, 136, 193, 0.3);
        }
        
        /* Редкости */
        .rarity-common { background: linear-gradient(135deg, #6b7280, #4b5563); }
        .rarity-rare { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .rarity-epic { background: linear-gradient(135deg, #8b5cf6, #6d28d9); }
        .rarity-legendary { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .rarity-custom { background: linear-gradient(135deg, #ec4899, #be185d); }
        
        .collection-card {
            background: linear-gradient(135deg, var(--color, #4f46e5) 0%, rgba(79, 70, 229, 0.8) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .gift-card {
            background: rgba(26, 26, 46, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .gift-card:hover {
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .telegram-button {
            background: var(--tg-theme-button-color, #5288c1);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 12px;
            padding: 14px 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(82, 136, 193, 0.3);
        }
        
        .telegram-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(82, 136, 193, 0.4);
        }
        
        .telegram-button:active {
            transform: translateY(0);
        }
        
        .telegram-input {
            background: rgba(26, 26, 46, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: var(--tg-theme-text-color, #ffffff);
            border-radius: 12px;
            padding: 14px 16px;
            font-size: 16px;
            width: 100%;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .telegram-input:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #5288c1);
            box-shadow: 0 0 0 4px rgba(82, 136, 193, 0.1);
        }
        
        .card {
            background: rgba(26, 26, 46, 0.8);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #5288c1, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 8px 0 calc(8px + env(safe-area-inset-bottom));
            z-index: 1000;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 4px;
            text-decoration: none;
            color: #6b7280;
            transition: all 0.2s ease;
            border-radius: 12px;
            margin: 0 4px;
        }
        
        .nav-item.active {
            color: var(--tg-theme-button-color, #5288c1);
            background: rgba(82, 136, 193, 0.1);
        }
        
        .nav-item:hover {
            color: var(--tg-theme-button-color, #5288c1);
            background: rgba(82, 136, 193, 0.05);
        }
        
        .app-content {
            padding-bottom: 80px;
        }
        
        .search-bar {
            position: sticky;
            top: 0;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(20px);
            z-index: 100;
            padding: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .floating-button {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--tg-theme-button-color, #5288c1);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(82, 136, 193, 0.4);
            transition: all 0.3s ease;
            z-index: 999;
        }
        
        .floating-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(82, 136, 193, 0.5);
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal {
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }
        
        @media (max-width: 480px) {
            .telegram-button {
                padding: 12px 16px;
                font-size: 15px;
            }
            
            .telegram-input {
                padding: 12px 14px;
                font-size: 15px;
            }
            
            .floating-button {
                width: 50px;
                height: 50px;
                font-size: 20px;
                bottom: 85px;
                right: 16px;
            }
        }
        
        .emoji-preview {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            background: linear-gradient(135deg, #4f46e5, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .sort-button {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .sort-button:hover,
        .sort-button.active {
            background: var(--tg-theme-button-color, #5288c1);
            border-color: var(--tg-theme-button-color, #5288c1);
        }
    </style>
</head>
<body>
    <div id="root">
        <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(180deg, #0a0a0a 0%, #1a1a2e 100%);">
            <div style="text-center; color: white;">
                <div style="font-size: 48px; margin-bottom: 16px;" class="spin">🎁</div>
                <h1 style="font-size: 24px; margin-bottom: 8px;">База подарков Telegram</h1>
                <p style="color: #94a3b8;">Загружается...</p>
            </div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // Инициализация Telegram WebApp
        let tg = null;
        
        try {
            if (window.Telegram && window.Telegram.WebApp) {
                tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
                tg.MainButton.hide();
                tg.BackButton.hide();
                console.log('🚀 Telegram WebApp инициализирован');
            }
        } catch (error) {
            console.error('❌ Ошибка инициализации Telegram WebApp:', error);
        }

        // Утилиты
        const Storage = {
            get: (key, defaultValue = null) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch (error) {
                    console.error('Ошибка чтения localStorage:', error);
                    return defaultValue;
                }
            },
            
            set: (key, value) => {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (error) {
                    console.error('Ошибка записи localStorage:', error);
                }
            }
        };

        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

        // Константы
        const COLLECTION_COLORS = [
            '#ef4444', '#f97316', '#eab308', '#22c55e', 
            '#06b6d4', '#3b82f6', '#6366f1', '#8b5cf6', 
            '#ec4899', '#f43f5e', '#10b981', '#f59e0b'
        ];

        const RARITIES = {
            common: { name: 'Обычный', color: '#6b7280', weight: 1 },
            rare: { name: 'Редкий', color: '#3b82f6', weight: 2 },
            epic: { name: 'Эпический', color: '#8b5cf6', weight: 3 },
            legendary: { name: 'Легендарный', color: '#f59e0b', weight: 4 },
            custom: { name: 'Особый', color: '#ec4899', weight: 5 }
        };

        const SORT_OPTIONS = {
            name_asc: { label: 'По имени (А-Я)', field: 'name', order: 'asc' },
            name_desc: { label: 'По имени (Я-А)', field: 'name', order: 'desc' },
            rarity_asc: { label: 'По редкости ↑', field: 'rarity', order: 'asc' },
            rarity_desc: { label: 'По редкости ↓', field: 'rarity', order: 'desc' },
            date_asc: { label: 'Сначала старые', field: 'created_at', order: 'asc' },
            date_desc: { label: 'Сначала новые', field: 'created_at', order: 'desc' }
        };

        // Хук для управления темой
        const useTheme = () => {
            const [isDark, setIsDark] = useState(true);
            
            useEffect(() => {
                const savedTheme = Storage.get('theme', 'dark');
                setIsDark(savedTheme === 'dark');
            }, []);
            
            const toggleTheme = () => {
                const newTheme = isDark ? 'light' : 'dark';
                Storage.set('theme', newTheme);
                setIsDark(!isDark);
            };
            
            return { isDark, toggleTheme };
        };

        // Splash Screen
        const SplashScreen = ({ onComplete }) => {
            useEffect(() => {
                const timer = setTimeout(onComplete, 2000);
                return () => clearTimeout(timer);
            }, [onComplete]);

            return (
                <div className="telegram-app">
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="text-7xl mb-8 spin">🎁</div>
                            <h1 className="text-4xl font-bold text-white mb-4 gradient-text">
                                База подарков
                            </h1>
                            <h2 className="text-xl text-gray-300 mb-8">Telegram</h2>
                            <div className="flex justify-center space-x-2">
                                <div className="w-3 h-3 bg-blue-500 rounded-full pulse"></div>
                                <div className="w-3 h-3 bg-purple-500 rounded-full pulse" style={{animationDelay: '0.2s'}}></div>
                                <div className="w-3 h-3 bg-pink-500 rounded-full pulse" style={{animationDelay: '0.4s'}}></div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Нижняя навигация
        const BottomNavigation = ({ currentTab, onTabChange }) => {
            const tabs = [
                { id: 'home', icon: '🏠', label: 'Главная' },
                { id: 'collections', icon: '📦', label: 'Коллекции' },
                { id: 'gifts', icon: '🎁', label: 'Подарки' },
                { id: 'settings', icon: '⚙️', label: 'Настройки' }
            ];

            return (
                <div className="bottom-nav">
                    <div className="flex px-4">
                        {tabs.map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => onTabChange(tab.id)}
                                className={`nav-item ${currentTab === tab.id ? 'active' : ''}`}
                            >
                                <span className="text-xl mb-1">{tab.icon}</span>
                                <span className="text-xs font-medium">{tab.label}</span>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // Модальное окно
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={e => e.stopPropagation()}>
                        <div className="p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-xl font-bold text-white">{title}</h2>
                                <button 
                                    onClick={onClose}
                                    className="text-gray-400 hover:text-white text-2xl"
                                >
                                    ×
                                </button>
                            </div>
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // Главный экран
        const HomeScreen = ({ collections, gifts }) => {
            const totalCollections = Object.keys(collections).length;
            const totalGifts = Object.keys(gifts).length;
            
            const recentGifts = useMemo(() => {
                return Object.values(gifts)
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                    .slice(0, 5);
            }, [gifts]);
            
            const rarityStats = useMemo(() => {
                const stats = {};
                Object.values(gifts).forEach(gift => {
                    stats[gift.rarity] = (stats[gift.rarity] || 0) + 1;
                });
                return stats;
            }, [gifts]);

            return (
                <div className="app-content p-4 fade-in">
                    <div className="max-w-md mx-auto">
                        {/* Заголовок */}
                        <div className="text-center mb-8 pt-4">
                            <div className="text-6xl mb-4">🎁</div>
                            <h1 className="text-3xl font-bold mb-2 gradient-text">База подарков</h1>
                            <p className="text-gray-400">Управляй коллекциями Telegram</p>
                        </div>

                        {/* Статистика */}
                        <div className="grid grid-cols-2 gap-4 mb-8">
                            <div className="card p-6 text-center">
                                <div className="text-3xl font-bold text-blue-400 mb-1">{totalCollections}</div>
                                <div className="text-sm text-gray-400">Коллекций</div>
                            </div>
                            <div className="card p-6 text-center">
                                <div className="text-3xl font-bold text-green-400 mb-1">{totalGifts}</div>
                                <div className="text-sm text-gray-400">Подарков</div>
                            </div>
                        </div>

                        {/* Статистика по редкости */}
                        {totalGifts > 0 && (
                            <div className="card p-6 mb-8">
                                <h3 className="text-lg font-semibold mb-4 text-white">📊 По редкости</h3>
                                <div className="space-y-3">
                                    {Object.entries(RARITIES).map(([key, rarity]) => {
                                        const count = rarityStats[key] || 0;
                                        const percentage = totalGifts > 0 ? Math.round((count / totalGifts) * 100) : 0;
                                        
                                        return (
                                            <div key={key} className="flex items-center justify-between">
                                                <div className="flex items-center">
                                                    <div 
                                                        className="w-4 h-4 rounded mr-3"
                                                        style={{ backgroundColor: rarity.color }}
                                                    />
                                                    <span className="text-gray-300">{rarity.name}</span>
                                                </div>
                                                <div className="text-white font-medium">
                                                    {count} ({percentage}%)
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* Последние подарки */}
                        {recentGifts.length > 0 && (
                            <div className="mb-8">
                                <h3 className="text-xl font-semibold mb-4 text-white">🆕 Последние добавленные</h3>
                                <div className="space-y-3">
                                    {recentGifts.map(gift => {
                                        const collection = collections[gift.collection_id];
                                        const rarity = RARITIES[gift.rarity];
                                        return (
                                            <div key={gift.id} className="gift-card p-4 rounded-xl">
                                                <div className="flex items-center justify-between">
                                                    <div className="flex items-center">
                                                        <div className="emoji-preview mr-3">
                                                            {gift.emoji_id ? '🎨' : '🎁'}
                                                        </div>
                                                        <div>
                                                            <div className="font-medium text-white">{gift.name}</div>
                                                            <div className="text-sm text-gray-400">{collection?.name}</div>
                                                        </div>
                                                    </div>
                                                    <div 
                                                        className="px-3 py-1 rounded-full text-xs text-white font-medium"
                                                        style={{ backgroundColor: rarity.color }}
                                                    >
                                                        {rarity.name}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* Пустое состояние */}
                        {totalCollections === 0 && (
                            <div className="text-center py-16">
                                <div className="text-6xl mb-6">📦</div>
                                <h3 className="text-xl font-semibold text-white mb-2">Добро пожаловать!</h3>
                                <p className="text-gray-400 mb-6">
                                    Создайте свою первую коллекцию подарков
                                </p>
                                <div className="text-sm text-gray-500">
                                    Перейдите на вкладку "Коллекции" для начала
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Экран коллекций
        const CollectionsScreen = ({ collections, gifts, onSelectCollection, onCreateCollection, onEditCollection, onDeleteCollection }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [sortBy, setSortBy] = useState('name_asc');
            
            const filteredAndSortedCollections = useMemo(() => {
                let filtered = Object.entries(collections).filter(([id, collection]) =>
                    collection.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (collection.description && collection.description.toLowerCase().includes(searchTerm.toLowerCase()))
                );

                const sortOption = SORT_OPTIONS[sortBy];
                if (sortOption) {
                    filtered.sort((a, b) => {
                        const aValue = a[1][sortOption.field];
                        const bValue = b[1][sortOption.field];
                        
                        if (sortOption.field === 'created_at') {
                            const aDate = new Date(aValue);
                            const bDate = new Date(bValue);
                            return sortOption.order === 'asc' ? aDate - bDate : bDate - aDate;
                        }
                        
                        const comparison = aValue.localeCompare(bValue);
                        return sortOption.order === 'asc' ? comparison : -comparison;
                    });
                }

                return filtered;
            }, [collections, searchTerm, sortBy]);

            const getGiftCount = (collectionId) => {
                return Object.values(gifts).filter(gift => gift.collection_id === collectionId).length;
            };

            return (
                <div className="app-content fade-in">
                    {/* Поиск и сортировка */}
                    <div className="search-bar">
                        <div className="max-w-md mx-auto space-y-4">
                            <input
                                type="text"
                                placeholder="🔍 Поиск коллекций..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="telegram-input"
                            />
                            <div className="flex gap-2 overflow-x-auto pb-2">
                                {Object.entries(SORT_OPTIONS).map(([key, option]) => (
                                    <button
                                        key={key}
                                        onClick={() => setSortBy(key)}
                                        className={`sort-button whitespace-nowrap ${sortBy === key ? 'active' : ''}`}
                                    >
                                        {option.label}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="p-4">
                        <div className="max-w-md mx-auto">
                            {/* Заголовок с счетчиком */}
                            <div className="mb-6">
                                <h1 className="text-2xl font-bold text-white mb-2">
                                    📦 Коллекции ({filteredAndSortedCollections.length})
                                </h1>
                                {searchTerm && (
                                    <p className="text-gray-400 text-sm">
                                        Результаты поиска: "{searchTerm}"
                                    </p>
                                )}
                            </div>

                            {/* Список коллекций */}
                            <div className="space-y-4">
                                {filteredAndSortedCollections.length === 0 ? (
                                    <div className="text-center py-16">
                                        <div className="text-5xl mb-4">
                                            {searchTerm ? '🔍' : '📦'}
                                        </div>
                                        <h3 className="text-xl font-semibold text-white mb-2">
                                            {searchTerm ? 'Ничего не найдено' : 'Пока нет коллекций'}
                                        </h3>
                                        <p className="text-gray-400 mb-6">
                                            {searchTerm 
                                                ? 'Попробуйте изменить поисковый запрос' 
                                                : 'Создайте свою первую коллекцию подарков'
                                            }
                                        </p>
                                        {!searchTerm && (
                                            <button 
                                                onClick={onCreateCollection}
                                                className="telegram-button"
                                            >
                                                ➕ Создать коллекцию
                                            </button>
                                        )}
                                    </div>
                                ) : (
                                    filteredAndSortedCollections.map(([id, collection]) => (
                                        <div
                                            key={id}
                                            className="collection-card rounded-xl p-5 cursor-pointer transition-all duration-300 hover:scale-[1.02] relative group"
                                            style={{ '--color': collection.color }}
                                            onClick={() => onSelectCollection(id)}
                                        >
                                            {/* Кнопки управления */}
                                            <div className="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        onEditCollection(collection);
                                                    }}
                                                    className="w-8 h-8 bg-black/20 hover:bg-black/40 rounded-lg flex items-center justify-center text-white transition-colors"
                                                >
                                                    ✏️
                                                </button>
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        onDeleteCollection(id);
                                                    }}
                                                    className="w-8 h-8 bg-black/20 hover:bg-red-500/60 rounded-lg flex items-center justify-center text-white transition-colors"
                                                >
                                                    🗑️
                                                </button>
                                            </div>

                                            <div className="flex justify-between items-start">
                                                <div className="flex-1 pr-4">
                                                    <h3 className="font-bold text-xl text-white mb-2">
                                                        {collection.name}
                                                    </h3>
                                                    {collection.description && (
                                                        <p className="text-white/80 text-sm mb-3 line-clamp-2">
                                                            {collection.description}
                                                        </p>
                                                    )}
                                                    <div className="flex items-center gap-4 text-white/90 text-sm">
                                                        <span>📊 {getGiftCount(id)} подарков</span>
                                                        <span>📅 {new Date(collection.created_at).toLocaleDateString('ru')}</span>
                                                    </div>
                                                </div>
                                                <div className="text-3xl opacity-80">📦</div>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Floating Action Button */}
                    <button 
                        onClick={onCreateCollection}
                        className="floating-button"
                        title="Добавить коллекцию"
                    >
                        ➕
                    </button>
                </div>
            );
        };

        // Экран всех подарков
        const GiftsScreen = ({ collections, gifts, onEditGift, onDeleteGift }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [sortBy, setSortBy] = useState('date_desc');
            const [filterRarity, setFilterRarity] = useState('all');
            const [filterCollection, setFilterCollection] = useState('all');

            const filteredAndSortedGifts = useMemo(() => {
                let filtered = Object.values(gifts).filter(gift => {
                    const matchesSearch = gift.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                        (gift.description && gift.description.toLowerCase().includes(searchTerm.toLowerCase()));
                    
                    const matchesRarity = filterRarity === 'all' || gift.rarity === filterRarity;
                    const matchesCollection = filterCollection === 'all' || gift.collection_id === filterCollection;
                    
                    return matchesSearch && matchesRarity && matchesCollection;
                });

                const sortOption = SORT_OPTIONS[sortBy];
                if (sortOption) {
                    filtered.sort((a, b) => {
                        if (sortOption.field === 'rarity') {
                            const aWeight = RARITIES[a.rarity].weight;
                            const bWeight = RARITIES[b.rarity].weight;
                            return sortOption.order === 'asc' ? aWeight - bWeight : bWeight - aWeight;
                        }
                        
                        if (sortOption.field === 'created_at') {
                            const aDate = new Date(a.created_at);
                            const bDate = new Date(b.created_at);
                            return sortOption.order === 'asc' ? aDate - bDate : bDate - aDate;
                        }
                        
                        const aValue = a[sortOption.field];
                        const bValue = b[sortOption.field];
                        const comparison = aValue.localeCompare(bValue);
                        return sortOption.order === 'asc' ? comparison : -comparison;
                    });
                }

                return filtered;
            }, [gifts, searchTerm, sortBy, filterRarity, filterCollection]);

            return (
                <div className="app-content fade-in">
                    {/* Поиск и фильтры */}
                    <div className="search-bar">
                        <div className="max-w-md mx-auto space-y-4">
                            <input
                                type="text"
                                placeholder="🔍 Поиск подарков..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="telegram-input"
                            />
                            
                            {/* Фильтры */}
                            <div className="grid grid-cols-2 gap-3">
                                <select
                                    value={filterRarity}
                                    onChange={(e) => setFilterRarity(e.target.value)}
                                    className="telegram-input py-2"
                                >
                                    <option value="all">Все редкости</option>
                                    {Object.entries(RARITIES).map(([key, rarity]) => (
                                        <option key={key} value={key}>{rarity.name}</option>
                                    ))}
                                </select>
                                
                                <select
                                    value={filterCollection}
                                    onChange={(e) => setFilterCollection(e.target.value)}
                                    className="telegram-input py-2"
                                >
                                    <option value="all">Все коллекции</option>
                                    {Object.entries(collections).map(([id, collection]) => (
                                        <option key={id} value={id}>{collection.name}</option>
                                    ))}
                                </select>
                            </div>
                            
                            {/* Сортировка */}
                            <div className="flex gap-2 overflow-x-auto pb-2">
                                {Object.entries(SORT_OPTIONS).map(([key, option]) => (
                                    <button
                                        key={key}
                                        onClick={() => setSortBy(key)}
                                        className={`sort-button whitespace-nowrap ${sortBy === key ? 'active' : ''}`}
                                    >
                                        {option.label}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="p-4">
                        <div className="max-w-md mx-auto">
                            {/* Заголовок */}
                            <div className="mb-6">
                                <h1 className="text-2xl font-bold text-white mb-2">
                                    🎁 Все подарки ({filteredAndSortedGifts.length})
                                </h1>
                                {(searchTerm || filterRarity !== 'all' || filterCollection !== 'all') && (
                                    <div className="flex flex-wrap gap-2 text-sm">
                                        {searchTerm && (
                                            <span className="px-2 py-1 bg-blue-500/20 text-blue-300 rounded">
                                                "{searchTerm}"
                                            </span>
                                        )}
                                        {filterRarity !== 'all' && (
                                            <span className="px-2 py-1 bg-purple-500/20 text-purple-300 rounded">
                                                {RARITIES[filterRarity].name}
                                            </span>
                                        )}
                                        {filterCollection !== 'all' && (
                                            <span className="px-2 py-1 bg-green-500/20 text-green-300 rounded">
                                                {collections[filterCollection]?.name}
                                            </span>
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* Список подарков */}
                            <div className="space-y-3">
                                {filteredAndSortedGifts.length === 0 ? (
                                    <div className="text-center py-16">
                                        <div className="text-5xl mb-4">
                                            {searchTerm || filterRarity !== 'all' || filterCollection !== 'all' ? '🔍' : '🎁'}
                                        </div>
                                        <h3 className="text-xl font-semibold text-white mb-2">
                                            {searchTerm || filterRarity !== 'all' || filterCollection !== 'all' 
                                                ? 'Ничего не найдено' 
                                                : 'Пока нет подарков'
                                            }
                                        </h3>
                                        <p className="text-gray-400">
                                            {searchTerm || filterRarity !== 'all' || filterCollection !== 'all'
                                                ? 'Попробуйте изменить фильтры или поиск'
                                                : 'Добавьте подарки в ваши коллекции'
                                            }
                                        </p>
                                    </div>
                                ) : (
                                    filteredAndSortedGifts.map(gift => {
                                        const collection = collections[gift.collection_id];
                                        const rarity = RARITIES[gift.rarity];
                                        
                                        return (
                                            <div key={gift.id} className="gift-card p-4 rounded-xl group">
                                                <div className="flex items-start justify-between">
                                                    <div className="flex items-start flex-1">
                                                        <div className="emoji-preview mr-4 mt-1 flex-shrink-0">
                                                            {gift.emoji_id ? '🎨' : '🎁'}
                                                        </div>
                                                        <div className="flex-1 min-w-0">
                                                            <h3 className="font-semibold text-white text-lg mb-1 break-words">
                                                                {gift.name}
                                                            </h3>
                                                            <div className="text-sm text-gray-400 mb-2">
                                                                📦 {collection?.name || 'Неизвестная коллекция'}
                                                            </div>
                                                            {gift.description && (
                                                                <p className="text-gray-400 text-sm mb-3 break-words">
                                                                    {gift.description}
                                                                </p>
                                                            )}
                                                            <div className="flex items-center gap-3 flex-wrap">
                                                                <span 
                                                                    className="inline-block px-3 py-1 rounded-full text-xs text-white font-medium"
                                                                    style={{ backgroundColor: rarity.color }}
                                                                >
                                                                    {rarity.name}
                                                                </span>
                                                                <span className="text-xs text-gray-500">
                                                                    {new Date(gift.created_at).toLocaleDateString('ru')}
                                                                </span>
                                                            </div>
                                                            {gift.emoji_id && (
                                                                <div className="text-xs text-gray-500 mt-2 break-all">
                                                                    🎨 ID: {gift.emoji_id}
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-2 ml-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                        <button 
                                                            onClick={() => onEditGift(gift)}
                                                            className="p-2 text-blue-400 hover:text-blue-300 hover:bg-blue-500/20 rounded-lg transition-colors"
                                                            title="Редактировать"
                                                        >
                                                            ✏️
                                                        </button>
                                                        <button 
                                                            onClick={() => onDeleteGift(gift.id)}
                                                            className="p-2 text-red-400 hover:text-red-300 hover:bg-red-500/20 rounded-lg transition-colors"
                                                            title="Удалить"
                                                        >
                                                            🗑️
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Экран настроек
        const SettingsScreen = ({ onExport, onImport, onReset, collections, gifts }) => {
            const { isDark, toggleTheme } = useTheme();
            const fileInputRef = useRef(null);

            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        onImport(data);
                    } catch (error) {
                        if (tg) {
                            tg.showAlert('Ошибка при импорте файла');
                        } else {
                            alert('Ошибка при импорте файла');
                        }
                    }
                };
                reader.readAsText(file);
            };

            const dataSize = JSON.stringify({ collections, gifts }).length;
            const dataSizeKB = Math.round(dataSize / 1024 * 100) / 100;

            return (
                <div className="app-content p-4 fade-in">
                    <div className="max-w-md mx-auto">
                        <h1 className="text-2xl font-bold mb-6 pt-4 text-white">⚙️ Настройки</h1>

                        <div className="space-y-4">
                            {/* Статистика */}
                            <div className="card p-5">
                                <h3 className="font-semibold mb-4 text-white text-lg">📊 Статистика</h3>
                                <div className="space-y-3 text-sm">
                                    <div className="flex justify-between">
                                        <span className="text-gray-400">Коллекций:</span>
                                        <span className="text-white font-medium">{Object.keys(collections).length}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-gray-400">Подарков:</span>
                                        <span className="text-white font-medium">{Object.keys(gifts).length}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-gray-400">Размер данных:</span>
                                        <span className="text-white font-medium">{dataSizeKB} КБ</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-gray-400">Версия:</span>
                                        <span className="text-white font-medium">1.0.0</span>
                                    </div>
                                </div>
                            </div>

                            {/* Экспорт */}
                            <div className="card p-5">
                                <h3 className="font-semibold mb-3 text-white text-lg">📤 Экспорт данных</h3>
                                <p className="text-gray-400 text-sm mb-4">
                                    Сохранить все коллекции и подарки в JSON файл для резервного копирования
                                </p>
                                <button 
                                    onClick={onExport}
                                    className="telegram-button w-full"
                                    disabled={Object.keys(collections).length === 0}
                                >
                                    📥 Экспортировать базу
                                </button>
                            </div>

                            {/* Импорт */}
                            <div className="card p-5">
                                <h3 className="font-semibold mb-3 text-white text-lg">📥 Импорт данных</h3>
                                <p className="text-gray-400 text-sm mb-4">
                                    Загрузить данные из JSON файла. <span className="text-orange-400">Внимание:</span> это заменит все текущие данные
                                </p>
                                <input
                                    type="file"
                                    ref={fileInputRef}
                                    onChange={handleImport}
                                    accept=".json"
                                    className="hidden"
                                />
                                <button 
                                    onClick={() => fileInputRef.current?.click()}
                                    className="w-full bg-gray-700 hover:bg-gray-600 text-white rounded-xl py-3 font-medium transition-colors"
                                >
                                    📁 Выбрать файл
                                </button>
                            </div>

                            {/* Сброс данных */}
                            <div className="card p-5">
                                <h3 className="font-semibold mb-3 text-white text-lg">🗑️ Сброс данных</h3>
                                <p className="text-gray-400 text-sm mb-4">
                                    Удалить все коллекции и подарки. <span className="text-red-400">Действие необратимо!</span>
                                </p>
                                <button 
                                    onClick={onReset}
                                    className="w-full bg-red-600 hover:bg-red-700 text-white rounded-xl py-3 font-medium transition-colors"
                                    disabled={Object.keys(collections).length === 0}
                                >
                                    🗑️ Очистить всё
                                </button>
                            </div>

                            {/* О приложении */}
                            <div className="card p-5">
                                <h3 className="font-semibold mb-3 text-white text-lg">ℹ️ О приложении</h3>
                                <div className="text-gray-400 text-sm space-y-2">
                                    <p><strong className="text-white">База подарков Telegram</strong> v1.0.0</p>
                                    <p>Полнофункциональное WebApp для управления коллекциями подарков</p>
                                    <p>Данные сохраняются локально на вашем устройстве</p>
                                    
                                    <div className="mt-4 p-3 bg-blue-900/30 rounded-lg">
                                        <p className="text-blue-200 text-xs">
                                            💡 <strong>Возможности:</strong> создание коллекций, добавление подарков, 
                                            система редкости, поиск и фильтрация, экспорт/импорт данных
                                        </p>
                                    </div>
                                </div>
                            </div>

                            {/* Telegram информация */}
                            {tg && (
                                <div className="card p-5">
                                    <h3 className="font-semibold mb-3 text-white text-lg">📱 Telegram WebApp</h3>
                                    <div className="text-gray-400 text-sm space-y-1">
                                        <p>Версия: {tg.version}</p>
                                        <p>Платформа: {tg.platform}</p>
                                        {tg.initDataUnsafe?.user && (
                                            <p>Пользователь: {tg.initDataUnsafe.user.first_name}</p>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Форма коллекции
        const CollectionForm = ({ collection, onSave, onCancel }) => {
            const [name, setName] = useState(collection?.name || '');
            const [description, setDescription] = useState(collection?.description || '');
            const [color, setColor] = useState(collection?.color || COLLECTION_COLORS[0]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!name.trim()) return;

                const collectionData = {
                    id: collection?.id || generateId(),
                    name: name.trim(),
                    description: description.trim(),
                    color,
                    created_at: collection?.created_at || new Date().toISOString()
                };

                onSave(collectionData);
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-6">
                    <div>
                        <label className="block text-sm font-medium mb-3 text-white">
                            Название *
                        </label>
                        <input
                            type="text"
                            value={name}
                            onChange={(e) => setName(e.target.value)}
                            placeholder="Название коллекции"
                            className="telegram-input"
                            required
                            maxLength={50}
                            autoFocus
                        />
                    </div>

                    <div>
                        <label className="block text-sm font-medium mb-3 text-white">
                            Описание
                        </label>
                        <textarea
                            value={description}
                            onChange={(e) => setDescription(e.target.value)}
                            placeholder="Краткое описание коллекции (необязательно)"
                            className="telegram-input resize-none"
                            rows="3"
                            maxLength={200}
                        />
                    </div>

                    <div>
                        <label className="block text-sm font-medium mb-3 text-white">
                            Цвет коллекции
                        </label>
                        <div className="grid grid-cols-6 gap-3">
                            {COLLECTION_COLORS.map(col => (
                                <button
                                    key={col}
                                    type="button"
                                    onClick={() => setColor(col)}
                                    className={`w-12 h-12 rounded-xl transition-all duration-200 ${
                                        color === col 
                                            ? 'border-4 border-white scale-110' 
                                            : 'border-2 border-transparent hover:scale-105'
                                    }`}
                                    style={{ backgroundColor: col }}
                                />
                            ))}
                        </div>
                    </div>

                    <div className="flex gap-3 pt-4">
                        <button
                            type="button"
                            onClick={onCancel}
                            className="flex-1 bg-gray-600 hover:bg-gray-500 text-white rounded-xl py-3 font-semibold transition-colors"
                        >
                            Отмена
                        </button>
                        <button
                            type="submit"
                            disabled={!name.trim()}
                            className="flex-1 telegram-button py-3 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            {collection ? 'Сохранить' : 'Создать'}
                        </button>
                    </div>
                </form>
            );
        };

        // Форма подарка
        const GiftForm = ({ gift, collections, onSave, onCancel }) => {
            const [name, setName] = useState(gift?.name || '');
            const [description, setDescription] = useState(gift?.description || '');
            const [rarity, setRarity] = useState(gift?.rarity || 'common');
            const [emojiId, setEmojiId] = useState(gift?.emoji_id || '');
            const [collectionId, setCollectionId] = useState(gift?.collection_id || Object.keys(collections)[0] || '');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!name.trim() || !collectionId) return;

                const giftData = {
                    id: gift?.id || generateId(),
                    name: name.trim(),
                    description: description.trim(),
                    rarity,
                    emoji_id: emojiId.trim(),
                    collection_id: collectionId,
                    created_at: gift?.created_at || new Date().toISOString()
                };

                onSave(giftData);
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-6">
                    <div>
                        <label className="block text-sm font-medium mb-3 text-white">
                            Название *
                        </label>
                        <input
                            type="text"
                            value={name}
                            onChange={(e) => setName(e.target.value)}
                            placeholder="Название подарка"
                            className="telegram-input"
                            required
                            maxLength={50}
                            autoFocus
                        />
                    </div>

                    <div>
                        <label className="block text-sm font-medium mb-3 text-white">
                            Коллекция *
                        </label>
                        <select
                            value={collectionId}
                            onChange={(e) => setCollectionId(e.target.value)}
                            className="telegram-input"
                            required
                        >
                            <option value="">Выберите коллекцию</option>
                            {Object.entries(collections).map(([id, collection]) => (
                                <option key={id} value={id}>
                                    {collection.name}
                                </option>
                            ))}
                        </select>
                    </div>

                    <div>
                        <label className="block text-sm font-medium mb-3 text-white">
                            Редкость
                        </label>
                        <div className="grid grid-cols-1 gap-2">
                            {Object.entries(RARITIES).map(([key, rarityData]) => (
                                <label
                                    key={key}
                                    className={`flex items-center p-3 rounded-xl border-2 cursor-pointer transition-all ${
                                        rarity === key 
                                            ? 'border-white bg-white/10' 
                                            : 'border-transparent bg-white/5 hover:bg-white/10'
                                    }`}
                                >
                                    <input
                                        type="radio"
                                        name="rarity"
                                        value={key}
                                        checked={rarity === key}
                                        onChange={(e) => setRarity(e.target.value)}
                                        className="sr-only"
                                    />
                                    <div 
                                        className="w-4 h-4 rounded mr-3"
                                        style={{ backgroundColor: rarityData.color }}
                                    />
                                    <span className="text-white font-medium">{rarityData.name}</span>
                                </label>
                            ))}
                        </div>
                    </div>

                    <div>
                        <label className="block text-sm font-medium mb-3 text-white">
                            Custom Emoji ID
                        </label>
                        <input
                            type="text"
                            value={emojiId}
                            onChange={(e) => setEmojiId(e.target.value)}
                            placeholder="Вставьте custom_emoji_id из Telegram"
                            className="telegram-input"
                        />
                        <p className="text-xs text-gray-400 mt-2">
                            ID кастомного эмодзи из Telegram (необязательно). Примеры: 5431821190513583006
                        </p>
                    </div>

                    <div>
                        <label className="block text-sm font-medium mb-3 text-white">
                            Описание
                        </label>
                        <textarea
                            value={description}
                            onChange={(e) => setDescription(e.target.value)}
                            placeholder="Описание подарка (необязательно)"
                            className="telegram-input resize-none"
                            rows="3"
                            maxLength={200}
                        />
                    </div>

                    <div className="flex gap-3 pt-4">
                        <button
                            type="button"
                            onClick={onCancel}
                            className="flex-1 bg-gray-600 hover:bg-gray-500 text-white rounded-xl py-3 font-semibold transition-colors"
                        >
                            Отмена
                        </button>
                        <button
                            type="submit"
                            disabled={!name.trim() || !collectionId}
                            className="flex-1 telegram-button py-3 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            {gift ? 'Сохранить' : 'Добавить'}
                        </button>
                    </div>
                </form>
            );
        };

        // Основное приложение
        const App = () => {
            const [currentTab, setCurrentTab] = useState('home');
            const [collections, setCollections] = useState({});
            const [gifts, setGifts] = useState({});
            const [isLoading, setIsLoading] = useState(true);
            
            // Модальные окна
            const [showCollectionForm, setShowCollectionForm] = useState(false);
            const [showGiftForm, setShowGiftForm] = useState(false);
            const [editingCollection, setEditingCollection] = useState(null);
            const [editingGift, setEditingGift] = useState(null);

            // Загрузка данных
            useEffect(() => {
                try {
                    const savedCollections = Storage.get('telegram_gifts_collections', {});
                    const savedGifts = Storage.get('telegram_gifts_data', {});
                    
                    setCollections(savedCollections);
                    setGifts(savedGifts);
                    
                    // Добавляем демо-данные если база пуста
                    if (Object.keys(savedCollections).length === 0) {
                        const demoCollections = {
                            'demo1': {
                                id: 'demo1',
                                name: 'Праздничные подарки',
                                description: 'Подарки к различным праздникам и событиям',
                                color: '#ef4444',
                                created_at: new Date().toISOString()
                            },
                            'demo2': {
                                id: 'demo2',
                                name: 'Игрушки',
                                description: 'Коллекция игрушек и сувениров',
                                color: '#22c55e',
                                created_at: new Date().toISOString()
                            },
                            'demo3': {
                                id: 'demo3',
                                name: 'Легендарные',
                                description: 'Самые редкие и ценные подарки',
                                color: '#8b5cf6',
                                created_at: new Date().toISOString()
                            }
                        };

                        const demoGifts = {
                            'gift1': {
                                id: 'gift1',
                                name: 'Jack-in-the-Box',
                                collection_id: 'demo2',
                                rarity: 'epic',
                                emoji_id: '5431821190513583006',
                                description: 'Классическая игрушка-сюрприз с пружинным механизмом',
                                created_at: new Date().toISOString()
                            },
                            'gift2': {
                                id: 'gift2',
                                name: 'Toy Bear',
                                collection_id: 'demo2',
                                rarity: 'rare',
                                emoji_id: '5357570547519613136',
                                description: 'Мягкий плюшевый мишка для детей и взрослых',
                                created_at: new Date().toISOString()
                            },
                            'gift3': {
                                id: 'gift3',
                                name: 'Новогодний подарок',
                                collection_id: 'demo1',
                                rarity: 'legendary',
                                emoji_id: '',
                                description: 'Особый подарок к Новому году с сюрпризом внутри',
                                created_at: new Date().toISOString()
                            },
                            'gift4': {
                                id: 'gift4',
                                name: 'День рождения',
                                collection_id: 'demo1',
                                rarity: 'common',
                                emoji_id: '',
                                description: 'Стандартный подарок ко дню рождения',
                                created_at: new Date().toISOString()
                            },
                            'gift5': {
                                id: 'gift5',
                                name: 'Золотой кубок',
                                collection_id: 'demo3',
                                rarity: 'legendary',
                                emoji_id: '',
                                description: 'Эксклюзивный золотой кубок для победителей',
                                created_at: new Date().toISOString()
                            }
                        };

                        setCollections(demoCollections);
                        setGifts(demoGifts);
                        Storage.set('telegram_gifts_collections', demoCollections);
                        Storage.set('telegram_gifts_data', demoGifts);
                    }
                    
                    setIsLoading(false);
                } catch (error) {
                    console.error('Ошибка загрузки данных:', error);
                    setIsLoading(false);
                }
            }, []);

            // Сохранение данных
            useEffect(() => {
                if (!isLoading) {
                    Storage.set('telegram_gifts_collections', collections);
                }
            }, [collections, isLoading]);

            useEffect(() => {
                if (!isLoading) {
                    Storage.set('telegram_gifts_data', gifts);
                }
            }, [gifts, isLoading]);

            // Функции управления коллекциями
            const saveCollection = (collection) => {
                setCollections(prev => ({
                    ...prev,
                    [collection.id]: collection
                }));
                setShowCollectionForm(false);
                setEditingCollection(null);
                
                if (tg) {
                    tg.showAlert(editingCollection ? 'Коллекция обновлена!' : 'Коллекция создана!');
                }
            };

            const editCollection = (collection) => {
                setEditingCollection(collection);
                setShowCollectionForm(true);
            };

            const deleteCollection = (collectionId) => {
                const confirmDelete = () => {
                    // Удаляем коллекцию
                    setCollections(prev => {
                        const newCollections = { ...prev };
                        delete newCollections[collectionId];
                        return newCollections;
                    });
                    
                    // Удаляем все подарки из этой коллекции
                    setGifts(prev => {
                        const newGifts = { ...prev };
                        Object.keys(newGifts).forEach(giftId => {
                            if (newGifts[giftId].collection_id === collectionId) {
                                delete newGifts[giftId];
                            }
                        });
                        return newGifts;
                    });
                    
                    if (tg) {
                        tg.showAlert('Коллекция и все её подарки удалены');
                    }
                };

                if (tg) {
                    tg.showConfirm('Удалить коллекцию и все её подарки?', confirmDelete);
                } else {
                    if (confirm('Удалить коллекцию и все её подарки?')) {
                        confirmDelete();
                    }
                }
            };

            const selectCollection = (collectionId) => {
                // Перейти на вкладку подарков с фильтром по коллекции
                setCurrentTab('gifts');
                // Можно добавить состояние для автоматической фильтрации
            };

            // Функции управления подарками
            const saveGift = (gift) => {
                setGifts(prev => ({
                    ...prev,
                    [gift.id]: gift
                }));
                setShowGiftForm(false);
                setEditingGift(null);
                
                if (tg) {
                    tg.showAlert(editingGift ? 'Подарок обновлён!' : 'Подарок добавлен!');
                }
            };

            const editGift = (gift) => {
                setEditingGift(gift);
                setShowGiftForm(true);
            };

            const deleteGift = (giftId) => {
                const confirmDelete = () => {
                    setGifts(prev => {
                        const newGifts = { ...prev };
                        delete newGifts[giftId];
                        return newGifts;
                    });
                    
                    if (tg) {
                        tg.showAlert('Подарок удалён');
                    }
                };

                if (tg) {
                    tg.showConfirm('Удалить этот подарок?', confirmDelete);
                } else {
                    if (confirm('Удалить этот подарок?')) {
                        confirmDelete();
                    }
                }
            };

            // Функции экспорта/импорта
            const exportData = () => {
                try {
                    const data = {
                        collections,
                        gifts,
                        exported_at: new Date().toISOString(),
                        version: '1.0.0',
                        app: 'Telegram Gifts Database'
                    };

                    const blob = new Blob([JSON.stringify(data, null, 2)], {
                        type: 'application/json'
                    });
                    
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `telegram-gifts-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    if (tg) {
                        tg.showAlert('База данных экспортирована!');
                    }
                } catch (error) {
                    console.error('Ошибка экспорта:', error);
                    if (tg) {
                        tg.showAlert('Ошибка при экспорте данных');
                    }
                }
            };

            const importData = (data) => {
                try {
                    if (data.collections && data.gifts) {
                        const confirmImport = () => {
                            setCollections(data.collections);
                            setGifts(data.gifts);
                            
                            if (tg) {
                                tg.showAlert('База данных импортирована!');
                            }
                        };

                        if (tg) {
                            tg.showConfirm('Импорт заменит все текущие данные. Продолжить?', confirmImport);
                        } else {
                            if (confirm('Импорт заменит все текущие данные. Продолжить?')) {
                                confirmImport();
                            }
                        }
                    } else {
                        if (tg) {
                            tg.showAlert('Неверный формат файла');
                        }
                    }
                } catch (error) {
                    console.error('Ошибка импорта:', error);
                    if (tg) {
                        tg.showAlert('Ошибка при импорте данных');
                    }
                }
            };

            const resetData = () => {
                const confirmReset = () => {
                    setCollections({});
                    setGifts({});
                    Storage.set('telegram_gifts_collections', {});
                    Storage.set('telegram_gifts_data', {});
                    
                    if (tg) {
                        tg.showAlert('Все данные удалены');
                    }
                };

                if (tg) {
                    tg.showConfirm('Удалить ВСЕ коллекции и подарки? Это действие нельзя отменить!', confirmReset);
                } else {
                    if (confirm('Удалить ВСЕ коллекции и подарки? Это действие нельзя отменить!')) {
                        confirmReset();
                    }
                }
            };

            // Обработчики модальных окон
            const handleCreateCollection = () => {
                setEditingCollection(null);
                setShowCollectionForm(true);
            };

            const handleCreateGift = () => {
                setEditingGift(null);
                setShowGiftForm(true);
            };

            const closeModals = () => {
                setShowCollectionForm(false);
                setShowGiftForm(false);
                setEditingCollection(null);
                setEditingGift(null);
            };

            // Обработчик смены вкладки
            const handleTabChange = (tab) => {
                setCurrentTab(tab);
                closeModals();
            };

            // Рендер загрузки
            if (isLoading) {
                return <SplashScreen onComplete={() => setIsLoading(false)} />;
            }

            // Рендер экранов
            const renderContent = () => {
                switch (currentTab) {
                    case 'home':
                        return (
                            <HomeScreen 
                                collections={collections}
                                gifts={gifts}
                            />
                        );
                    
                    case 'collections':
                        return (
                            <CollectionsScreen 
                                collections={collections}
                                gifts={gifts}
                                onSelectCollection={selectCollection}
                                onCreateCollection={handleCreateCollection}
                                onEditCollection={editCollection}
                                onDeleteCollection={deleteCollection}
                            />
                        );
                    
                    case 'gifts':
                        return (
                            <GiftsScreen 
                                collections={collections}
                                gifts={gifts}
                                onEditGift={editGift}
                                onDeleteGift={deleteGift}
                            />
                        );
                    
                    case 'settings':
                        return (
                            <SettingsScreen 
                                collections={collections}
                                gifts={gifts}
                                onExport={exportData}
                                onImport={importData}
                                onReset={resetData}
                            />
                        );
                    
                    default:
                        return (
                            <HomeScreen 
                                collections={collections}
                                gifts={gifts}
                            />
                        );
                }
            };

            return (
                <div className="telegram-app">
                    {renderContent()}
                    
                    <BottomNavigation 
                        currentTab={currentTab}
                        onTabChange={handleTabChange}
                    />

                    {/* Floating Action Button для добавления подарков */}
                    {currentTab === 'gifts' && Object.keys(collections).length > 0 && (
                        <button 
                            onClick={handleCreateGift}
                            className="floating-button"
                            title="Добавить подарок"
                        >
                            🎁
                        </button>
                    )}

                    {/* Модальные окна */}
                    <Modal
                        isOpen={showCollectionForm}
                        onClose={closeModals}
                        title={editingCollection ? 'Редактировать коллекцию' : 'Создать коллекцию'}
                    >
                        <CollectionForm
                            collection={editingCollection}
                            onSave={saveCollection}
                            onCancel={closeModals}
                        />
                    </Modal>

                    <Modal
                        isOpen={showGiftForm}
                        onClose={closeModals}
                        title={editingGift ? 'Редактировать подарок' : 'Добавить подарок'}
                    >
                        <GiftForm
                            gift={editingGift}
                            collections={collections}
                            onSave={saveGift}
                            onCancel={closeModals}
                        />
                    </Modal>
                </div>
            );
        };

        // Функция инициализации
        const initApp = () => {
            try {
                if (tg) {
                    tg.ready();
                    tg.expand();
                    tg.enableClosingConfirmation();
                    tg.MainButton.hide();
                    tg.BackButton.hide();
                    
                    console.log('🎁 Telegram WebApp настроен:', {
                        version: tg.version,
                        platform: tg.platform,
                        user: tg.initDataUnsafe?.user?.first_name
                    });
                }

                const root = document.getElementById('root');
                if (root) {
                    ReactDOM.render(<App />, root);
                    console.log('🚀 База подарков Telegram v1.0.0 запущена!');
                }
            } catch (error) {
                console.error('❌ Ошибка инициализации:', error);
                
                const root = document.getElementById('root');
                if (root) {
                    root.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: #0a0a0a; color: white; text-align: center; padding: 20px;">
                            <div>
                                <div style="font-size: 48px; margin-bottom: 16px;">❌</div>
                                <h2 style="margin-bottom: 8px;">Ошибка загрузки</h2>
                                <p style="color: #94a3b8; margin-bottom: 16px;">Произошла ошибка при запуске приложения</p>
                                <button onclick="window.location.reload()" style="background: #5288c1; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">
                                    Перезагрузить
                                </button>
                            </div>
                        </div>
                    `;
                }
            }
        };

        // Обработчики событий
        window.addEventListener('error', (event) => {
            console.error('🐛 Глобальная ошибка:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('🐛 Необработанный Promise:', event.reason);
        });

        // Предотвращение случайного закрытия
        window.addEventListener('beforeunload', (event) => {
            if (tg?.isClosingConfirmationEnabled) {
                event.preventDefault();
                event.returnValue = '';
            }
        });

        // Запуск приложения
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        // Глобальные переменные для отладки
        window.TelegramGiftsApp = {
            storage: Storage,
            telegram: tg,
            version: '1.0.0',
            generateId
        };
    </script>
</body>
</html>
