<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ë–∞–∑–∞ –ø–æ–¥–∞—Ä–∫–æ–≤ Telegram</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html, body {
            height: 100%;
            overflow-x: hidden;
        }
        
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'SF Pro Display', sans-serif;
            background: var(--tg-theme-bg-color, #0a0a0a);
            color: var(--tg-theme-text-color, #ffffff);
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
            line-height: 1.5;
        }
        
        #root {
            min-height: 100vh;
            width: 100%;
            position: relative;
        }
        
        .telegram-app {
            min-height: 100vh;
            background: linear-gradient(180deg, #0a0a0a 0%, #1a1a2e 100%);
            position: relative;
        }
        
        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .spin {
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .6; }
        }
        
        .glow {
            box-shadow: 0 0 20px rgba(82, 136, 193, 0.3);
        }
        
        /* –†–µ–¥–∫–æ—Å—Ç–∏ */
        .rarity-common { background: linear-gradient(135deg, #6b7280, #4b5563); }
        .rarity-rare { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .rarity-epic { background: linear-gradient(135deg, #8b5cf6, #6d28d9); }
        .rarity-legendary { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .rarity-custom { background: linear-gradient(135deg, #ec4899, #be185d); }
        
        .collection-card {
            background: linear-gradient(135deg, var(--color, #4f46e5) 0%, rgba(79, 70, 229, 0.8) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .gift-card {
            background: rgba(26, 26, 46, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .gift-card:hover {
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .telegram-button {
            background: var(--tg-theme-button-color, #5288c1);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 12px;
            padding: 14px 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(82, 136, 193, 0.3);
        }
        
        .telegram-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(82, 136, 193, 0.4);
        }
        
        .telegram-button:active {
            transform: translateY(0);
        }
        
        .telegram-input {
            background: rgba(26, 26, 46, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: var(--tg-theme-text-color, #ffffff);
            border-radius: 12px;
            padding: 14px 16px;
            font-size: 16px;
            width: 100%;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .telegram-input:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #5288c1);
            box-shadow: 0 0 0 4px rgba(82, 136, 193, 0.1);
        }
        
        .card {
            background: rgba(26, 26, 46, 0.8);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #5288c1, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 8px 0 calc(8px + env(safe-area-inset-bottom));
            z-index: 1000;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 4px;
            text-decoration: none;
            color: #6b7280;
            transition: all 0.2s ease;
            border-radius: 12px;
            margin: 0 4px;
        }
        
        .nav-item.active {
            color: var(--tg-theme-button-color, #5288c1);
            background: rgba(82, 136, 193, 0.1);
        }
        
        .nav-item:hover {
            color: var(--tg-theme-button-color, #5288c1);
            background: rgba(82, 136, 193, 0.05);
        }
        
        .app-content {
            padding-bottom: 80px;
        }
        
        .search-bar {
            position: sticky;
            top: 0;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(20px);
            z-index: 100;
            padding: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .floating-button {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--tg-theme-button-color, #5288c1);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(82, 136, 193, 0.4);
            transition: all 0.3s ease;
            z-index: 999;
        }
        
        .floating-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(82, 136, 193, 0.5);
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal {
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }
        
        @media (max-width: 480px) {
            .telegram-button {
                padding: 12px 16px;
                font-size: 15px;
            }
            
            .telegram-input {
                padding: 12px 14px;
                font-size: 15px;
            }
            
            .floating-button {
                width: 50px;
                height: 50px;
                font-size: 20px;
                bottom: 85px;
                right: 16px;
            }
        }
        
        .emoji-preview {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            background: linear-gradient(135deg, #4f46e5, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .sort-button {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .sort-button:hover,
        .sort-button.active {
            background: var(--tg-theme-button-color, #5288c1);
            border-color: var(--tg-theme-button-color, #5288c1);
        }
    </style>
</head>
<body>
    <div id="root">
        <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(180deg, #0a0a0a 0%, #1a1a2e 100%);">
            <div style="text-center; color: white;">
                <div style="font-size: 48px; margin-bottom: 16px;" class="spin">üéÅ</div>
                <h1 style="font-size: 24px; margin-bottom: 8px;">–ë–∞–∑–∞ –ø–æ–¥–∞—Ä–∫–æ–≤ Telegram</h1>
                <p style="color: #94a3b8;">–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</p>
            </div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        let tg = null;
        
        try {
            if (window.Telegram && window.Telegram.WebApp) {
                tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
                tg.MainButton.hide();
                tg.BackButton.hide();
                console.log('üöÄ Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram WebApp:', error);
        }

        // –£—Ç–∏–ª–∏—Ç—ã
        const Storage = {
            get: (key, defaultValue = null) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è localStorage:', error);
                    return defaultValue;
                }
            },
            
            set: (key, value) => {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ localStorage:', error);
                }
            }
        };

        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
        const COLLECTION_COLORS = [
            '#ef4444', '#f97316', '#eab308', '#22c55e', 
            '#06b6d4', '#3b82f6', '#6366f1', '#8b5cf6', 
            '#ec4899', '#f43f5e', '#10b981', '#f59e0b'
        ];

        const RARITIES = {
            common: { name: '–û–±—ã—á–Ω—ã–π', color: '#6b7280', weight: 1 },
            rare: { name: '–†–µ–¥–∫–∏–π', color: '#3b82f6', weight: 2 },
            epic: { name: '–≠–ø–∏—á–µ—Å–∫–∏–π', color: '#8b5cf6', weight: 3 },
            legendary: { name: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π', color: '#f59e0b', weight: 4 },
            custom: { name: '–û—Å–æ–±—ã–π', color: '#ec4899', weight: 5 }
        };

        const SORT_OPTIONS = {
            name_asc: { label: '–ü–æ –∏–º–µ–Ω–∏ (–ê-–Ø)', field: 'name', order: 'asc' },
            name_desc: { label: '–ü–æ –∏–º–µ–Ω–∏ (–Ø-–ê)', field: 'name', order: 'desc' },
            rarity_asc: { label: '–ü–æ —Ä–µ–¥–∫–æ—Å—Ç–∏ ‚Üë', field: 'rarity', order: 'asc' },
            rarity_desc: { label: '–ü–æ —Ä–µ–¥–∫–æ—Å—Ç–∏ ‚Üì', field: 'rarity', order: 'desc' },
            date_asc: { label: '–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ', field: 'created_at', order: 'asc' },
            date_desc: { label: '–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ', field: 'created_at', order: 'desc' }
        };

        // –•—É–∫ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ–º–æ–π
        const useTheme = () => {
            const [isDark, setIsDark] = useState(true);
            
            useEffect(() => {
                const savedTheme = Storage.get('theme', 'dark');
                setIsDark(savedTheme === 'dark');
            }, []);
            
            const toggleTheme = () => {
                const newTheme = isDark ? 'light' : 'dark';
                Storage.set('theme', newTheme);
                setIsDark(!isDark);
            };
            
            return { isDark, toggleTheme };
        };

        // Splash Screen
        const SplashScreen = ({ onComplete }) => {
            useEffect(() => {
                const timer = setTimeout(onComplete, 2000);
                return () => clearTimeout(timer);
            }, [onComplete]);

            return (
                <div className="telegram-app">
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="text-7xl mb-8 spin">üéÅ</div>
                            <h1 className="text-4xl font-bold text-white mb-4 gradient-text">
                                –ë–∞–∑–∞ –ø–æ–¥–∞—Ä–∫–æ–≤
                            </h1>
                            <h2 className="text-xl text-gray-300 mb-8">Telegram</h2>
                            <div className="flex justify-center space-x-2">
                                <div className="w-3 h-3 bg-blue-500 rounded-full pulse"></div>
                                <div className="w-3 h-3 bg-purple-500 rounded-full pulse" style={{animationDelay: '0.2s'}}></div>
                                <div className="w-3 h-3 bg-pink-500 rounded-full pulse" style={{animationDelay: '0.4s'}}></div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
        const BottomNavigation = ({ currentTab, onTabChange }) => {
            const tabs = [
                { id: 'home', icon: 'üè†', label: '–ì–ª–∞–≤–Ω–∞—è' },
                { id: 'collections', icon: 'üì¶', label: '–ö–æ–ª–ª–µ–∫—Ü–∏–∏' },
                { id: 'gifts', icon: 'üéÅ', label: '–ü–æ–¥–∞—Ä–∫–∏' },
                { id: 'settings', icon: '‚öôÔ∏è', label: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏' }
            ];

            return (
                <div className="bottom-nav">
                    <div className="flex px-4">
                        {tabs.map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => onTabChange(tab.id)}
                                className={`nav-item ${currentTab === tab.id ? 'active' : ''}`}
                            >
                                <span className="text-xl mb-1">{tab.icon}</span>
                                <span className="text-xs font-medium">{tab.label}</span>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={e => e.stopPropagation()}>
                        <div className="p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-xl font-bold text-white">{title}</h2>
                                <button 
                                    onClick={onClose}
                                    className="text-gray-400 hover:text-white text-2xl"
                                >
                                    √ó
                                </button>
                            </div>
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
        const HomeScreen = ({ collections, gifts }) => {
            const totalCollections = Object.keys(collections).length;
            const totalGifts = Object.keys(gifts).length;
            
            const recentGifts = useMemo(() => {
                return Object.values(gifts)
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                    .slice(0, 5);
            }, [gifts]);
            
            const rarityStats = useMemo(() => {
                const stats = {};
                Object.values(gifts).forEach(gift => {
                    stats[gift.rarity] = (stats[gift.rarity] || 0) + 1;
                });
                return stats;
            }, [gifts]);

            return (
                <div className="app-content p-4 fade-in">
                    <div className="max-w-md mx-auto">
                        {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */}
                        <div className="text-center mb-8 pt-4">
                            <div className="text-6xl mb-4">üéÅ</div>
                            <h1 className="text-3xl font-bold mb-2 gradient-text">–ë–∞–∑–∞ –ø–æ–¥–∞—Ä–∫–æ–≤</h1>
                            <p className="text-gray-400">–£–ø—Ä–∞–≤–ª—è–π –∫–æ–ª–ª–µ–∫—Ü–∏—è–º–∏ Telegram</p>
                        </div>

                        {/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */}
                        <div className="grid grid-cols-2 gap-4 mb-8">
                            <div className="card p-6 text-center">
                                <div className="text-3xl font-bold text-blue-400 mb-1">{totalCollections}</div>
                                <div className="text-sm text-gray-400">–ö–æ–ª–ª–µ–∫—Ü–∏–π</div>
                            </div>
                            <div className="card p-6 text-center">
                                <div className="text-3xl font-bold text-green-400 mb-1">{totalGifts}</div>
                                <div className="text-sm text-gray-400">–ü–æ–¥–∞—Ä–∫–æ–≤</div>
                            </div>
                        </div>

                        {/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–µ–¥–∫–æ—Å—Ç–∏ */}
                        {totalGifts > 0 && (
                            <div className="card p-6 mb-8">
                                <h3 className="text-lg font-semibold mb-4 text-white">üìä –ü–æ —Ä–µ–¥–∫–æ—Å—Ç–∏</h3>
                                <div className="space-y-3">
                                    {Object.entries(RARITIES).map(([key, rarity]) => {
                                        const count = rarityStats[key] || 0;
                                        const percentage = totalGifts > 0 ? Math.round((count / totalGifts) * 100) : 0;
                                        
                                        return (
                                            <div key={key} className="flex items-center justify-between">
                                                <div className="flex items-center">
                                                    <div 
                                                        className="w-4 h-4 rounded mr-3"
                                                        style={{ backgroundColor: rarity.color }}
                                                    />
                                                    <span className="text-gray-300">{rarity.name}</span>
                                                </div>
                                                <div className="text-white font-medium">
                                                    {count} ({percentage}%)
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∏ */}
                        {recentGifts.length > 0 && (
                            <div className="mb-8">
                                <h3 className="text-xl font-semibold mb-4 text-white">üÜï –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ</h3>
                                <div className="space-y-3">
                                    {recentGifts.map(gift => {
                                        const collection = collections[gift.collection_id];
                                        const rarity = RARITIES[gift.rarity];
                                        return (
                                            <div key={gift.id} className="gift-card p-4 rounded-xl">
                                                <div className="flex items-center justify-between">
                                                    <div className="flex items-center">
                                                        <div className="emoji-preview mr-3">
                                                            {gift.emoji_id ? 'üé®' : 'üéÅ'}
                                                        </div>
                                                        <div>
                                                            <div className="font-medium text-white">{gift.name}</div>
                                                            <div className="text-sm text-gray-400">{collection?.name}</div>
                                                        </div>
                                                    </div>
                                                    <div 
                                                        className="px-3 py-1 rounded-full text-xs text-white font-medium"
                                                        style={{ backgroundColor: rarity.color }}
                                                    >
                                                        {rarity.name}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */}
                        {totalCollections === 0 && (
                            <div className="text-center py-16">
                                <div className="text-6xl mb-6">üì¶</div>
                                <h3 className="text-xl font-semibold text-white mb-2">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h3>
                                <p className="text-gray-400 mb-6">
                                    –°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é –ø–æ–¥–∞—Ä–∫–æ–≤
                                </p>
                                <div className="text-sm text-gray-500">
                                    –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–ö–æ–ª–ª–µ–∫—Ü–∏–∏" –¥–ª—è –Ω–∞—á–∞–ª–∞
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // –≠–∫—Ä–∞–Ω –∫–æ–ª–ª–µ–∫—Ü–∏–π
        const CollectionsScreen = ({ collections, gifts, onSelectCollection, onCreateCollection, onEditCollection, onDeleteCollection }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [sortBy, setSortBy] = useState('name_asc');
            
            const filteredAndSortedCollections = useMemo(() => {
                let filtered = Object.entries(collections).filter(([id, collection]) =>
                    collection.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (collection.description && collection.description.toLowerCase().includes(searchTerm.toLowerCase()))
                );

                const sortOption = SORT_OPTIONS[sortBy];
                if (sortOption) {
                    filtered.sort((a, b) => {
                        const aValue = a[1][sortOption.field];
                        const bValue = b[1][sortOption.field];
                        
                        if (sortOption.field === 'created_at') {
                            const aDate = new Date(aValue);
                            const bDate = new Date(bValue);
                            return sortOption.order === 'asc' ? aDate - bDate : bDate - aDate;
                        }
                        
                        const comparison = aValue.localeCompare(bValue);
                        return sortOption.order === 'asc' ? comparison : -comparison;
                    });
                }

                return filtered;
            }, [collections, searchTerm, sortBy]);

            const getGiftCount = (collectionId) => {
                return Object.values(gifts).filter(gift => gift.collection_id === collectionId).length;
            };

            return (
                <div className="app-content fade-in">
                    {/* –ü–æ–∏—Å–∫ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ */}
                    <div className="search-bar">
                        <div className="max-w-md mx-auto space-y-4">
                            <input
                                type="text"
                                placeholder="üîç –ü–æ–∏—Å–∫ –∫–æ–ª–ª–µ–∫—Ü–∏–π..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="telegram-input"
                            />
                            <div className="flex gap-2 overflow-x-auto pb-2">
                                {Object.entries(SORT_OPTIONS).map(([key, option]) => (
                                    <button
                                        key={key}
                                        onClick={() => setSortBy(key)}
                                        className={`sort-button whitespace-nowrap ${sortBy === key ? 'active' : ''}`}
                                    >
                                        {option.label}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="p-4">
                        <div className="max-w-md mx-auto">
                            {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å —Å—á–µ—Ç—á–∏–∫–æ–º */}
                            <div className="mb-6">
                                <h1 className="text-2xl font-bold text-white mb-2">
                                    üì¶ –ö–æ–ª–ª–µ–∫—Ü–∏–∏ ({filteredAndSortedCollections.length})
                                </h1>
                                {searchTerm && (
                                    <p className="text-gray-400 text-sm">
                                        –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞: "{searchTerm}"
                                    </p>
                                )}
                            </div>

                            {/* –°–ø–∏—Å–æ–∫ –∫–æ–ª–ª–µ–∫—Ü–∏–π */}
                            <div className="space-y-4">
                                {filteredAndSortedCollections.length === 0 ? (
                                    <div className="text-center py-16">
                                        <div className="text-5xl mb-4">
                                            {searchTerm ? 'üîç' : 'üì¶'}
                                        </div>
                                        <h3 className="text-xl font-semibold text-white mb-2">
                                            {searchTerm ? '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' : '–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–ª–ª–µ–∫—Ü–∏–π'}
                                        </h3>
                                        <p className="text-gray-400 mb-6">
                                            {searchTerm 
                                                ? '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å' 
                                                : '–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é –ø–æ–¥–∞—Ä–∫–æ–≤'
                                            }
                                        </p>
                                        {!searchTerm && (
                                            <button 
                                                onClick={onCreateCollection}
                                                className="telegram-button"
                                            >
                                                ‚ûï –°–æ–∑–¥–∞—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é
                                            </button>
                                        )}
                                    </div>
                                ) : (
                                    filteredAndSortedCollections.map(([id, collection]) => (
                                        <div
                                            key={id}
                                            className="collection-card rounded-xl p-5 cursor-pointer transition-all duration-300 hover:scale-[1.02] relative group"
                                            style={{ '--color': collection.color }}
                                            onClick={() => onSelectCollection(id)}
                                        >
                                            {/* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */}
                                            <div className="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        onEditCollection(collection);
                                                    }}
                                                    className="w-8 h-8 bg-black/20 hover:bg-black/40 rounded-lg flex items-center justify-center text-white transition-colors"
                                                >
                                                    ‚úèÔ∏è
                                                </button>
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        onDeleteCollection(id);
                                                    }}
                                                    className="w-8 h-8 bg-black/20 hover:bg-red-500/60 rounded-lg flex items-center justify-center text-white transition-colors"
                                                >
                                                    üóëÔ∏è
                                                </button>
                                            </div>

                                            <div className="flex justify-between items-start">
                                                <div className="flex-1 pr-4">
                                                    <h3 className="font-bold text-xl text-white mb-2">
                                                        {collection.name}
                                                    </h3>
                                                    {collection.description && (
                                                        <p className="text-white/80 text-sm mb-3 line-clamp-2">
                                                            {collection.description}
                                                        </p>
                                                    )}
                                                    <div className="flex items-center gap-4 text-white/90 text-sm">
                                                        <span>üìä {getGiftCount(id)} –ø–æ–¥–∞—Ä–∫–æ–≤</span>
                                                        <span>üìÖ {new Date(collection.created_at).toLocaleDateString('ru')}</span>
                                                    </div>
                                                </div>
                                                <div className="text-3xl opacity-80">üì¶</div>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Floating Action Button */}
                    <button 
                        onClick={onCreateCollection}
                        className="floating-button"
                        title="–î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é"
                    >
                        ‚ûï
                    </button>
                </div>
            );
        };

        // –≠–∫—Ä–∞–Ω –≤—Å–µ—Ö –ø–æ–¥–∞—Ä–∫–æ–≤
        const GiftsScreen = ({ collections, gifts, onEditGift, onDeleteGift }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [sortBy, setSortBy] = useState('date_desc');
            const [filterRarity, setFilterRarity] = useState('all');
            const [filterCollection, setFilterCollection] = useState('all');

            const filteredAndSortedGifts = useMemo(() => {
                let filtered = Object.values(gifts).filter(gift => {
                    const matchesSearch = gift.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                        (gift.description && gift.description.toLowerCase().includes(searchTerm.toLowerCase()));
                    
                    const matchesRarity = filterRarity === 'all' || gift.rarity === filterRarity;
                    const matchesCollection = filterCollection === 'all' || gift.collection_id === filterCollection;
                    
                    return matchesSearch && matchesRarity && matchesCollection;
                });

                const sortOption = SORT_OPTIONS[sortBy];
                if (sortOption) {
                    filtered.sort((a, b) => {
                        if (sortOption.field === 'rarity') {
                            const aWeight = RARITIES[a.rarity].weight;
                            const bWeight = RARITIES[b.rarity].weight;
                            return sortOption.order === 'asc' ? aWeight - bWeight : bWeight - aWeight;
                        }
                        
                        if (sortOption.field === 'created_at') {
                            const aDate = new Date(a.created_at);
                            const bDate = new Date(b.created_at);
                            return sortOption.order === 'asc' ? aDate - bDate : bDate - aDate;
                        }
                        
                        const aValue = a[sortOption.field];
                        const bValue = b[sortOption.field];
                        const comparison = aValue.localeCompare(bValue);
                        return sortOption.order === 'asc' ? comparison : -comparison;
                    });
                }

                return filtered;
            }, [gifts, searchTerm, sortBy, filterRarity, filterCollection]);

            return (
                <div className="app-content fade-in">
                    {/* –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã */}
                    <div className="search-bar">
                        <div className="max-w-md mx-auto space-y-4">
                            <input
                                type="text"
                                placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ–¥–∞—Ä–∫–æ–≤..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="telegram-input"
                            />
                            
                            {/* –§–∏–ª—å—Ç—Ä—ã */}
                            <div className="grid grid-cols-2 gap-3">
                                <select
                                    value={filterRarity}
                                    onChange={(e) => setFilterRarity(e.target.value)}
                                    className="telegram-input py-2"
                                >
                                    <option value="all">–í—Å–µ —Ä–µ–¥–∫–æ—Å—Ç–∏</option>
                                    {Object.entries(RARITIES).map(([key, rarity]) => (
                                        <option key={key} value={key}>{rarity.name}</option>
                                    ))}
                                </select>
                                
                                <select
                                    value={filterCollection}
                                    onChange={(e) => setFilterCollection(e.target.value)}
                                    className="telegram-input py-2"
                                >
                                    <option value="all">–í—Å–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</option>
                                    {Object.entries(collections).map(([id, collection]) => (
                                        <option key={id} value={id}>{collection.name}</option>
                                    ))}
                                </select>
                            </div>
                            
                            {/* –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ */}
                            <div className="flex gap-2 overflow-x-auto pb-2">
                                {Object.entries(SORT_OPTIONS).map(([key, option]) => (
                                    <button
                                        key={key}
                                        onClick={() => setSortBy(key)}
                                        className={`sort-button whitespace-nowrap ${sortBy === key ? 'active' : ''}`}
                                    >
                                        {option.label}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="p-4">
                        <div className="max-w-md mx-auto">
                            {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */}
                            <div className="mb-6">
                                <h1 className="text-2xl font-bold text-white mb-2">
                                    üéÅ –í—Å–µ –ø–æ–¥–∞—Ä–∫–∏ ({filteredAndSortedGifts.length})
                                </h1>
                                {(searchTerm || filterRarity !== 'all' || filterCollection !== 'all') && (
                                    <div className="flex flex-wrap gap-2 text-sm">
                                        {searchTerm && (
                                            <span className="px-2 py-1 bg-blue-500/20 text-blue-300 rounded">
                                                "{searchTerm}"
                                            </span>
                                        )}
                                        {filterRarity !== 'all' && (
                                            <span className="px-2 py-1 bg-purple-500/20 text-purple-300 rounded">
                                                {RARITIES[filterRarity].name}
                                            </span>
                                        )}
                                        {filterCollection !== 'all' && (
                                            <span className="px-2 py-1 bg-green-500/20 text-green-300 rounded">
                                                {collections[filterCollection]?.name}
                                            </span>
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* –°–ø–∏—Å–æ–∫ –ø–æ–¥–∞—Ä–∫–æ–≤ */}
                            <div className="space-y-3">
                                {filteredAndSortedGifts.length === 0 ? (
                                    <div className="text-center py-16">
                                        <div className="text-5xl mb-4">
                                            {searchTerm || filterRarity !== 'all' || filterCollection !== 'all' ? 'üîç' : 'üéÅ'}
                                        </div>
                                        <h3 className="text-xl font-semibold text-white mb-2">
                                            {searchTerm || filterRarity !== 'all' || filterCollection !== 'all' 
                                                ? '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' 
                                                : '–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–¥–∞—Ä–∫–æ–≤'
                                            }
                                        </h3>
                                        <p className="text-gray-400">
                                            {searchTerm || filterRarity !== 'all' || filterCollection !== 'all'
                                                ? '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –ø–æ–∏—Å–∫'
                                                : '–î–æ–±–∞–≤—å—Ç–µ –ø–æ–¥–∞—Ä–∫–∏ –≤ –≤–∞—à–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏'
                                            }
                                        </p>
                                    </div>
                                ) : (
                                    filteredAndSortedGifts.map(gift => {
                                        const collection = collections[gift.collection_id];
                                        const rarity = RARITIES[gift.rarity];
                                        
                                        return (
                                            <div key={gift.id} className="gift-card p-4 rounded-xl group">
                                                <div className="flex items-start justify-between">
                                                    <div className="flex items-start flex-1">
                                                        <div className="emoji-preview mr-4 mt-1 flex-shrink-0">
                                                            {gift.emoji_id ? 'üé®' : 'üéÅ'}
                                                        </div>
                                                        <div className="flex-1 min-w-0">
                                                            <h3 className="font-semibold text-white text-lg mb-1 break-words">
                                                                {gift.name}
                                                            </h3>
                                                            <div className="text-sm text-gray-400 mb-2">
                                                                üì¶ {collection?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è'}
                                                            </div>
                                                            {gift.description && (
                                                                <p className="text-gray-400 text-sm mb-3 break-words">
                                                                    {gift.description}
                                                                </p>
                                                            )}
                                                            <div className="flex items-center gap-3 flex-wrap">
                                                                <span 
                                                                    className="inline-block px-3 py-1 rounded-full text-xs text-white font-medium"
                                                                    style={{ backgroundColor: rarity.color }}
                                                                >
                                                                    {rarity.name}
                                                                </span>
                                                                <span className="text-xs text-gray-500">
                                                                    {new Date(gift.created_at).toLocaleDateString('ru')}
                                                                </span>
                                                            </div>
                                                            {gift.emoji_id && (
                                                                <div className="text-xs text-gray-500 mt-2 break-all">
                                                                    üé® ID: {gift.emoji_id}
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-2 ml-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                        <button 
                                                            onClick={() => onEditGift(gift)}
                                                            className="p-2 text-blue-400 hover:text-blue-300 hover:bg-blue-500/20 rounded-lg transition-colors"
                                                            title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                                                        >
                                                            ‚úèÔ∏è
                                                        </button>
                                                        <button 
                                                            onClick={() => onDeleteGift(gift.id)}
                                                            className="p-2 text-red-400 hover:text-red-300 hover:bg-red-500/20 rounded-lg transition-colors"
                                                            title="–£–¥–∞–ª–∏—Ç—å"
                                                        >
                                                            üóëÔ∏è
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // –≠–∫—Ä–∞–Ω –Ω–∞—Å—Ç—Ä–æ–µ–∫
        const SettingsScreen = ({ onExport, onImport, onReset, collections, gifts }) => {
            const { isDark, toggleTheme } = useTheme();
            const fileInputRef = useRef(null);

            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        onImport(data);
                    } catch (error) {
                        if (tg) {
                            tg.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ —Ñ–∞–π–ª–∞');
                        } else {
                            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ —Ñ–∞–π–ª–∞');
                        }
                    }
                };
                reader.readAsText(file);
            };

            const dataSize = JSON.stringify({ collections, gifts }).length;
            const dataSizeKB = Math.round(dataSize / 1024 * 100) / 100;

            return (
                <div className="app-content p-4 fade-in">
                    <div className="max-w-md mx-auto">
                        <h1 className="text-2xl font-bold mb-6 pt-4 text-white">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>

                        <div className="space-y-4">
                            {/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */}
                            <div className="card p-5">
                                <h3 className="font-semibold mb-4 text-white text-lg">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                                <div className="space-y-3 text-sm">
                                    <div className="flex justify-between">
                                        <span className="text-gray-400">–ö–æ–ª–ª–µ–∫—Ü–∏–π:</span>
                                        <span className="text-white font-medium">{Object.keys(collections).length}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-gray-400">–ü–æ–¥–∞—Ä–∫–æ–≤:</span>
                                        <span className="text-white font-medium">{Object.keys(gifts).length}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-gray-400">–†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö:</span>
                                        <span className="text-white font-medium">{dataSizeKB} –ö–ë</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-gray-400">–í–µ—Ä—Å–∏—è:</span>
                                        <span className="text-white font-medium">1.0.0</span>
                                    </div>
                                </div>
                            </div>

                            {/* –≠–∫—Å–ø–æ—Ä—Ç */}
                            <div className="card p-5">
                                <h3 className="font-semibold mb-3 text-white text-lg">üì§ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
                                <p className="text-gray-400 text-sm mb-4">
                                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –∏ –ø–æ–¥–∞—Ä–∫–∏ –≤ JSON —Ñ–∞–π–ª –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
                                </p>
                                <button 
                                    onClick={onExport}
                                    className="telegram-button w-full"
                                    disabled={Object.keys(collections).length === 0}
                                >
                                    üì• –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –±–∞–∑—É
                                </button>
                            </div>

                            {/* –ò–º–ø–æ—Ä—Ç */}
                            <div className="card p-5">
                                <h3 className="font-semibold mb-3 text-white text-lg">üì• –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
                                <p className="text-gray-400 text-sm mb-4">
                                    –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ JSON —Ñ–∞–π–ª–∞. <span className="text-orange-400">–í–Ω–∏–º–∞–Ω–∏–µ:</span> —ç—Ç–æ –∑–∞–º–µ–Ω–∏—Ç –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
                                </p>
                                <input
                                    type="file"
                                    ref={fileInputRef}
                                    onChange={handleImport}
                                    accept=".json"
                                    className="hidden"
                                />
                                <button 
                                    onClick={() => fileInputRef.current?.click()}
                                    className="w-full bg-gray-700 hover:bg-gray-600 text-white rounded-xl py-3 font-medium transition-colors"
                                >
                                    üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                                </button>
                            </div>

                            {/* –°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö */}
                            <div className="card p-5">
                                <h3 className="font-semibold mb-3 text-white text-lg">üóëÔ∏è –°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö</h3>
                                <p className="text-gray-400 text-sm mb-4">
                                    –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –∏ –ø–æ–¥–∞—Ä–∫–∏. <span className="text-red-400">–î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!</span>
                                </p>
                                <button 
                                    onClick={onReset}
                                    className="w-full bg-red-600 hover:bg-red-700 text-white rounded-xl py-3 font-medium transition-colors"
                                    disabled={Object.keys(collections).length === 0}
                                >
                                    üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë
                                </button>
                            </div>

                            {/* –û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ */}
                            <div className="card p-5">
                                <h3 className="font-semibold mb-3 text-white text-lg">‚ÑπÔ∏è –û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</h3>
                                <div className="text-gray-400 text-sm space-y-2">
                                    <p><strong className="text-white">–ë–∞–∑–∞ –ø–æ–¥–∞—Ä–∫–æ–≤ Telegram</strong> v1.0.0</p>
                                    <p>–ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ WebApp –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–ª–µ–∫—Ü–∏—è–º–∏ –ø–æ–¥–∞—Ä–∫–æ–≤</p>
                                    <p>–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ –≤–∞—à–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</p>
                                    
                                    <div className="mt-4 p-3 bg-blue-900/30 rounded-lg">
                                        <p className="text-blue-200 text-xs">
                                            üí° <strong>–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</strong> —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–π, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–æ–≤, 
                                            —Å–∏—Å—Ç–µ–º–∞ —Ä–µ–¥–∫–æ—Å—Ç–∏, –ø–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è, —ç–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
                                        </p>
                                    </div>
                                </div>
                            </div>

                            {/* Telegram –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
                            {tg && (
                                <div className="card p-5">
                                    <h3 className="font-semibold mb-3 text-white text-lg">üì± Telegram WebApp</h3>
                                    <div className="text-gray-400 text-sm space-y-1">
                                        <p>–í–µ—Ä—Å–∏—è: {tg.version}</p>
                                        <p>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: {tg.platform}</p>
                                        {tg.initDataUnsafe?.user && (
                                            <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {tg.initDataUnsafe.user.first_name}</p>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // –§–æ—Ä–º–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
        const CollectionForm = ({ collection, onSave, onCancel }) => {
            const [name, setName] = useState(collection?.name || '');
            const [description, setDescription] = useState(collection?.description || '');
            const [color, setColor] = useState(collection?.color || COLLECTION_COLORS[0]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!name.trim()) return;

                const collectionData = {
                    id: collection?.id || generateId(),
                    name: name.trim(),
                    description: description.trim(),
                    color,
                    created_at: collection?.created_at || new Date().toISOString()
                };

                onSave(collectionData);
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-6">
                    <div>
                        <label className="block text-sm font-medium mb-3 text-white">
                            –ù–∞–∑–≤–∞–Ω–∏–µ *
                        </label>
                        <input
                            type="text"
                            value={name}
                            onChange={(e) => setName(e.target.value)}
                            placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏"
                            className="telegram-input"
                            required
                            maxLength={50}
                            autoFocus
                        />
                    </div>

                    <div>
                        <label className="block text-sm font-medium mb-3 text-white">
                            –û–ø–∏—Å–∞–Ω–∏–µ
                        </label>
                        <textarea
                            value={description}
                            onChange={(e) => setDescription(e.target.value)}
                            placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
                            className="telegram-input resize-none"
                            rows="3"
                            maxLength={200}
                        />
                    </div>

                    <div>
                        <label className="block text-sm font-medium mb-3 text-white">
                            –¶–≤–µ—Ç –∫–æ–ª–ª–µ–∫—Ü–∏–∏
                        </label>
                        <div className="grid grid-cols-6 gap-3">
                            {COLLECTION_COLORS.map(col => (
                                <button
                                    key={col}
                                    type="button"
                                    onClick={() => setColor(col)}
                                    className={`w-12 h-12 rounded-xl transition-all duration-200 ${
                                        color === col 
                                            ? 'border-4 border-white scale-110' 
                                            : 'border-2 border-transparent hover:scale-105'
                                    }`}
                                    style={{ backgroundColor: col }}
                                />
                            ))}
                        </div>
                    </div>

                    <div className="flex gap-3 pt-4">
                        <button
                            type="button"
                            onClick={onCancel}
                            className="flex-1 bg-gray-600 hover:bg-gray-500 text-white rounded-xl py-3 font-semibold transition-colors"
                        >
                            –û—Ç–º–µ–Ω–∞
                        </button>
                        <button
                            type="submit"
                            disabled={!name.trim()}
                            className="flex-1 telegram-button py-3 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            {collection ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–°–æ–∑–¥–∞—Ç—å'}
                        </button>
                    </div>
                </form>
            );
        };

        // –§–æ—Ä–º–∞ –ø–æ–¥–∞—Ä–∫–∞
        const GiftForm = ({ gift, collections, onSave, onCancel }) => {
            const [name, setName] = useState(gift?.name || '');
            const [description, setDescription] = useState(gift?.description || '');
            const [rarity, setRarity] = useState(gift?.rarity || 'common');
            const [emojiId, setEmojiId] = useState(gift?.emoji_id || '');
            const [collectionId, setCollectionId] = useState(gift?.collection_id || Object.keys(collections)[0] || '');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!name.trim() || !collectionId) return;

                const giftData = {
                    id: gift?.id || generateId(),
                    name: name.trim(),
                    description: description.trim(),
                    rarity,
                    emoji_id: emojiId.trim(),
                    collection_id: collectionId,
                    created_at: gift?.created_at || new Date().toISOString()
                };

                onSave(giftData);
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-6">
                    <div>
                        <label className="block text-sm font-medium mb-3 text-white">
                            –ù–∞–∑–≤–∞–Ω–∏–µ *
                        </label>
                        <input
                            type="text"
                            value={name}
                            onChange={(e) => setName(e.target.value)}
                            placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∞"
                            className="telegram-input"
                            required
                            maxLength={50}
                            autoFocus
                        />
                    </div>

                    <div>
                        <label className="block text-sm font-medium mb-3 text-white">
                            –ö–æ–ª–ª–µ–∫—Ü–∏—è *
                        </label>
                        <select
                            value={collectionId}
                            onChange={(e) => setCollectionId(e.target.value)}
                            className="telegram-input"
                            required
                        >
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏—é</option>
                            {Object.entries(collections).map(([id, collection]) => (
                                <option key={id} value={id}>
                                    {collection.name}
                                </option>
                            ))}
                        </select>
                    </div>

                    <div>
                        <label className="block text-sm font-medium mb-3 text-white">
                            –†–µ–¥–∫–æ—Å—Ç—å
                        </label>
                        <div className="grid grid-cols-1 gap-2">
                            {Object.entries(RARITIES).map(([key, rarityData]) => (
                                <label
                                    key={key}
                                    className={`flex items-center p-3 rounded-xl border-2 cursor-pointer transition-all ${
                                        rarity === key 
                                            ? 'border-white bg-white/10' 
                                            : 'border-transparent bg-white/5 hover:bg-white/10'
                                    }`}
                                >
                                    <input
                                        type="radio"
                                        name="rarity"
                                        value={key}
                                        checked={rarity === key}
                                        onChange={(e) => setRarity(e.target.value)}
                                        className="sr-only"
                                    />
                                    <div 
                                        className="w-4 h-4 rounded mr-3"
                                        style={{ backgroundColor: rarityData.color }}
                                    />
                                    <span className="text-white font-medium">{rarityData.name}</span>
                                </label>
                            ))}
                        </div>
                    </div>

                    <div>
                        <label className="block text-sm font-medium mb-3 text-white">
                            Custom Emoji ID
                        </label>
                        <input
                            type="text"
                            value={emojiId}
                            onChange={(e) => setEmojiId(e.target.value)}
                            placeholder="–í—Å—Ç–∞–≤—å—Ç–µ custom_emoji_id –∏–∑ Telegram"
                            className="telegram-input"
                        />
                        <p className="text-xs text-gray-400 mt-2">
                            ID –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —ç–º–æ–¥–∑–∏ –∏–∑ Telegram (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ). –ü—Ä–∏–º–µ—Ä—ã: 5431821190513583006
                        </p>
                    </div>

                    <div>
                        <label className="block text-sm font-medium mb-3 text-white">
                            –û–ø–∏—Å–∞–Ω–∏–µ
                        </label>
                        <textarea
                            value={description}
                            onChange={(e) => setDescription(e.target.value)}
                            placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
                            className="telegram-input resize-none"
                            rows="3"
                            maxLength={200}
                        />
                    </div>

                    <div className="flex gap-3 pt-4">
                        <button
                            type="button"
                            onClick={onCancel}
                            className="flex-1 bg-gray-600 hover:bg-gray-500 text-white rounded-xl py-3 font-semibold transition-colors"
                        >
                            –û—Ç–º–µ–Ω–∞
                        </button>
                        <button
                            type="submit"
                            disabled={!name.trim() || !collectionId}
                            className="flex-1 telegram-button py-3 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            {gift ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–î–æ–±–∞–≤–∏—Ç—å'}
                        </button>
                    </div>
                </form>
            );
        };

        // –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        const App = () => {
            const [currentTab, setCurrentTab] = useState('home');
            const [collections, setCollections] = useState({});
            const [gifts, setGifts] = useState({});
            const [isLoading, setIsLoading] = useState(true);
            
            // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
            const [showCollectionForm, setShowCollectionForm] = useState(false);
            const [showGiftForm, setShowGiftForm] = useState(false);
            const [editingCollection, setEditingCollection] = useState(null);
            const [editingGift, setEditingGift] = useState(null);

            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            useEffect(() => {
                try {
                    const savedCollections = Storage.get('telegram_gifts_collections', {});
                    const savedGifts = Storage.get('telegram_gifts_data', {});
                    
                    setCollections(savedCollections);
                    setGifts(savedGifts);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –±–∞–∑–∞ –ø—É—Å—Ç–∞
                    if (Object.keys(savedCollections).length === 0) {
                        const demoCollections = {
                            'demo1': {
                                id: 'demo1',
                                name: '–ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏',
                                description: '–ü–æ–¥–∞—Ä–∫–∏ –∫ —Ä–∞–∑–ª–∏—á–Ω—ã–º –ø—Ä–∞–∑–¥–Ω–∏–∫–∞–º –∏ —Å–æ–±—ã—Ç–∏—è–º',
                                color: '#ef4444',
                                created_at: new Date().toISOString()
                            },
                            'demo2': {
                                id: 'demo2',
                                name: '–ò–≥—Ä—É—à–∫–∏',
                                description: '–ö–æ–ª–ª–µ–∫—Ü–∏—è –∏–≥—Ä—É—à–µ–∫ –∏ —Å—É–≤–µ–Ω–∏—Ä–æ–≤',
                                color: '#22c55e',
                                created_at: new Date().toISOString()
                            },
                            'demo3': {
                                id: 'demo3',
                                name: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–µ',
                                description: '–°–∞–º—ã–µ —Ä–µ–¥–∫–∏–µ –∏ —Ü–µ–Ω–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏',
                                color: '#8b5cf6',
                                created_at: new Date().toISOString()
                            }
                        };

                        const demoGifts = {
                            'gift1': {
                                id: 'gift1',
                                name: 'Jack-in-the-Box',
                                collection_id: 'demo2',
                                rarity: 'epic',
                                emoji_id: '5431821190513583006',
                                description: '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –∏–≥—Ä—É—à–∫–∞-—Å—é—Ä–ø—Ä–∏–∑ —Å –ø—Ä—É–∂–∏–Ω–Ω—ã–º –º–µ—Ö–∞–Ω–∏–∑–º–æ–º',
                                created_at: new Date().toISOString()
                            },
                            'gift2': {
                                id: 'gift2',
                                name: 'Toy Bear',
                                collection_id: 'demo2',
                                rarity: 'rare',
                                emoji_id: '5357570547519613136',
                                description: '–ú—è–≥–∫–∏–π –ø–ª—é—à–µ–≤—ã–π –º–∏—à–∫–∞ –¥–ª—è –¥–µ—Ç–µ–π –∏ –≤–∑—Ä–æ—Å–ª—ã—Ö',
                                created_at: new Date().toISOString()
                            },
                            'gift3': {
                                id: 'gift3',
                                name: '–ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –ø–æ–¥–∞—Ä–æ–∫',
                                collection_id: 'demo1',
                                rarity: 'legendary',
                                emoji_id: '',
                                description: '–û—Å–æ–±—ã–π –ø–æ–¥–∞—Ä–æ–∫ –∫ –ù–æ–≤–æ–º—É –≥–æ–¥—É —Å —Å—é—Ä–ø—Ä–∏–∑–æ–º –≤–Ω—É—Ç—Ä–∏',
                                created_at: new Date().toISOString()
                            },
                            'gift4': {
                                id: 'gift4',
                                name: '–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è',
                                collection_id: 'demo1',
                                rarity: 'common',
                                emoji_id: '',
                                description: '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ –∫–æ –¥–Ω—é —Ä–æ–∂–¥–µ–Ω–∏—è',
                                created_at: new Date().toISOString()
                            },
                            'gift5': {
                                id: 'gift5',
                                name: '–ó–æ–ª–æ—Ç–æ–π –∫—É–±–æ–∫',
                                collection_id: 'demo3',
                                rarity: 'legendary',
                                emoji_id: '',
                                description: '–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π –∑–æ–ª–æ—Ç–æ–π –∫—É–±–æ–∫ –¥–ª—è –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π',
                                created_at: new Date().toISOString()
                            }
                        };

                        setCollections(demoCollections);
                        setGifts(demoGifts);
                        Storage.set('telegram_gifts_collections', demoCollections);
                        Storage.set('telegram_gifts_data', demoGifts);
                    }
                    
                    setIsLoading(false);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                    setIsLoading(false);
                }
            }, []);

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
            useEffect(() => {
                if (!isLoading) {
                    Storage.set('telegram_gifts_collections', collections);
                }
            }, [collections, isLoading]);

            useEffect(() => {
                if (!isLoading) {
                    Storage.set('telegram_gifts_data', gifts);
                }
            }, [gifts, isLoading]);

            // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–ª–µ–∫—Ü–∏—è–º–∏
            const saveCollection = (collection) => {
                setCollections(prev => ({
                    ...prev,
                    [collection.id]: collection
                }));
                setShowCollectionForm(false);
                setEditingCollection(null);
                
                if (tg) {
                    tg.showAlert(editingCollection ? '–ö–æ–ª–ª–µ–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞!' : '–ö–æ–ª–ª–µ–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞!');
                }
            };

            const editCollection = (collection) => {
                setEditingCollection(collection);
                setShowCollectionForm(true);
            };

            const deleteCollection = (collectionId) => {
                const confirmDelete = () => {
                    // –£–¥–∞–ª—è–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏—é
                    setCollections(prev => {
                        const newCollections = { ...prev };
                        delete newCollections[collectionId];
                        return newCollections;
                    });
                    
                    // –£–¥–∞–ª—è–µ–º –≤—Å–µ –ø–æ–¥–∞—Ä–∫–∏ –∏–∑ —ç—Ç–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏
                    setGifts(prev => {
                        const newGifts = { ...prev };
                        Object.keys(newGifts).forEach(giftId => {
                            if (newGifts[giftId].collection_id === collectionId) {
                                delete newGifts[giftId];
                            }
                        });
                        return newGifts;
                    });
                    
                    if (tg) {
                        tg.showAlert('–ö–æ–ª–ª–µ–∫—Ü–∏—è –∏ –≤—Å–µ –µ—ë –ø–æ–¥–∞—Ä–∫–∏ —É–¥–∞–ª–µ–Ω—ã');
                    }
                };

                if (tg) {
                    tg.showConfirm('–£–¥–∞–ª–∏—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é –∏ –≤—Å–µ –µ—ë –ø–æ–¥–∞—Ä–∫–∏?', confirmDelete);
                } else {
                    if (confirm('–£–¥–∞–ª–∏—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é –∏ –≤—Å–µ –µ—ë –ø–æ–¥–∞—Ä–∫–∏?')) {
                        confirmDelete();
                    }
                }
            };

            const selectCollection = (collectionId) => {
                // –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É –ø–æ–¥–∞—Ä–∫–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
                setCurrentTab('gifts');
                // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
            };

            // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–∞—Ä–∫–∞–º–∏
            const saveGift = (gift) => {
                setGifts(prev => ({
                    ...prev,
                    [gift.id]: gift
                }));
                setShowGiftForm(false);
                setEditingGift(null);
                
                if (tg) {
                    tg.showAlert(editingGift ? '–ü–æ–¥–∞—Ä–æ–∫ –æ–±–Ω–æ–≤–ª—ë–Ω!' : '–ü–æ–¥–∞—Ä–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω!');
                }
            };

            const editGift = (gift) => {
                setEditingGift(gift);
                setShowGiftForm(true);
            };

            const deleteGift = (giftId) => {
                const confirmDelete = () => {
                    setGifts(prev => {
                        const newGifts = { ...prev };
                        delete newGifts[giftId];
                        return newGifts;
                    });
                    
                    if (tg) {
                        tg.showAlert('–ü–æ–¥–∞—Ä–æ–∫ —É–¥–∞–ª—ë–Ω');
                    }
                };

                if (tg) {
                    tg.showConfirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ–¥–∞—Ä–æ–∫?', confirmDelete);
                } else {
                    if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ–¥–∞—Ä–æ–∫?')) {
                        confirmDelete();
                    }
                }
            };

            // –§—É–Ω–∫—Ü–∏–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞/–∏–º–ø–æ—Ä—Ç–∞
            const exportData = () => {
                try {
                    const data = {
                        collections,
                        gifts,
                        exported_at: new Date().toISOString(),
                        version: '1.0.0',
                        app: 'Telegram Gifts Database'
                    };

                    const blob = new Blob([JSON.stringify(data, null, 2)], {
                        type: 'application/json'
                    });
                    
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `telegram-gifts-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    if (tg) {
                        tg.showAlert('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞!');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
                    if (tg) {
                        tg.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö');
                    }
                }
            };

            const importData = (data) => {
                try {
                    if (data.collections && data.gifts) {
                        const confirmImport = () => {
                            setCollections(data.collections);
                            setGifts(data.gifts);
                            
                            if (tg) {
                                tg.showAlert('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞!');
                            }
                        };

                        if (tg) {
                            tg.showConfirm('–ò–º–ø–æ—Ä—Ç –∑–∞–º–µ–Ω–∏—Ç –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?', confirmImport);
                        } else {
                            if (confirm('–ò–º–ø–æ—Ä—Ç –∑–∞–º–µ–Ω–∏—Ç –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                                confirmImport();
                            }
                        }
                    } else {
                        if (tg) {
                            tg.showAlert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
                        }
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:', error);
                    if (tg) {
                        tg.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö');
                    }
                }
            };

            const resetData = () => {
                const confirmReset = () => {
                    setCollections({});
                    setGifts({});
                    Storage.set('telegram_gifts_collections', {});
                    Storage.set('telegram_gifts_data', {});
                    
                    if (tg) {
                        tg.showAlert('–í—Å–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã');
                    }
                };

                if (tg) {
                    tg.showConfirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –∏ –ø–æ–¥–∞—Ä–∫–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!', confirmReset);
                } else {
                    if (confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –∏ –ø–æ–¥–∞—Ä–∫–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
                        confirmReset();
                    }
                }
            };

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
            const handleCreateCollection = () => {
                setEditingCollection(null);
                setShowCollectionForm(true);
            };

            const handleCreateGift = () => {
                setEditingGift(null);
                setShowGiftForm(true);
            };

            const closeModals = () => {
                setShowCollectionForm(false);
                setShowGiftForm(false);
                setEditingCollection(null);
                setEditingGift(null);
            };

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–º–µ–Ω—ã –≤–∫–ª–∞–¥–∫–∏
            const handleTabChange = (tab) => {
                setCurrentTab(tab);
                closeModals();
            };

            // –†–µ–Ω–¥–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            if (isLoading) {
                return <SplashScreen onComplete={() => setIsLoading(false)} />;
            }

            // –†–µ–Ω–¥–µ—Ä —ç–∫—Ä–∞–Ω–æ–≤
            const renderContent = () => {
                switch (currentTab) {
                    case 'home':
                        return (
                            <HomeScreen 
                                collections={collections}
                                gifts={gifts}
                            />
                        );
                    
                    case 'collections':
                        return (
                            <CollectionsScreen 
                                collections={collections}
                                gifts={gifts}
                                onSelectCollection={selectCollection}
                                onCreateCollection={handleCreateCollection}
                                onEditCollection={editCollection}
                                onDeleteCollection={deleteCollection}
                            />
                        );
                    
                    case 'gifts':
                        return (
                            <GiftsScreen 
                                collections={collections}
                                gifts={gifts}
                                onEditGift={editGift}
                                onDeleteGift={deleteGift}
                            />
                        );
                    
                    case 'settings':
                        return (
                            <SettingsScreen 
                                collections={collections}
                                gifts={gifts}
                                onExport={exportData}
                                onImport={importData}
                                onReset={resetData}
                            />
                        );
                    
                    default:
                        return (
                            <HomeScreen 
                                collections={collections}
                                gifts={gifts}
                            />
                        );
                }
            };

            return (
                <div className="telegram-app">
                    {renderContent()}
                    
                    <BottomNavigation 
                        currentTab={currentTab}
                        onTabChange={handleTabChange}
                    />

                    {/* Floating Action Button –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–∞—Ä–∫–æ–≤ */}
                    {currentTab === 'gifts' && Object.keys(collections).length > 0 && (
                        <button 
                            onClick={handleCreateGift}
                            className="floating-button"
                            title="–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫"
                        >
                            üéÅ
                        </button>
                    )}

                    {/* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */}
                    <Modal
                        isOpen={showCollectionForm}
                        onClose={closeModals}
                        title={editingCollection ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é' : '–°–æ–∑–¥–∞—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é'}
                    >
                        <CollectionForm
                            collection={editingCollection}
                            onSave={saveCollection}
                            onCancel={closeModals}
                        />
                    </Modal>

                    <Modal
                        isOpen={showGiftForm}
                        onClose={closeModals}
                        title={editingGift ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–∞—Ä–æ–∫' : '–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫'}
                    >
                        <GiftForm
                            gift={editingGift}
                            collections={collections}
                            onSave={saveGift}
                            onCancel={closeModals}
                        />
                    </Modal>
                </div>
            );
        };

        // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        const initApp = () => {
            try {
                if (tg) {
                    tg.ready();
                    tg.expand();
                    tg.enableClosingConfirmation();
                    tg.MainButton.hide();
                    tg.BackButton.hide();
                    
                    console.log('üéÅ Telegram WebApp –Ω–∞—Å—Ç—Ä–æ–µ–Ω:', {
                        version: tg.version,
                        platform: tg.platform,
                        user: tg.initDataUnsafe?.user?.first_name
                    });
                }

                const root = document.getElementById('root');
                if (root) {
                    ReactDOM.render(<App />, root);
                    console.log('üöÄ –ë–∞–∑–∞ –ø–æ–¥–∞—Ä–∫–æ–≤ Telegram v1.0.0 –∑–∞–ø—É—â–µ–Ω–∞!');
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                
                const root = document.getElementById('root');
                if (root) {
                    root.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: #0a0a0a; color: white; text-align: center; padding: 20px;">
                            <div>
                                <div style="font-size: 48px; margin-bottom: 16px;">‚ùå</div>
                                <h2 style="margin-bottom: 8px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h2>
                                <p style="color: #94a3b8; margin-bottom: 16px;">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</p>
                                <button onclick="window.location.reload()" style="background: #5288c1; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">
                                    –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    `;
                }
            }
        };

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        window.addEventListener('error', (event) => {
            console.error('üêõ –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('üêõ –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π Promise:', event.reason);
        });

        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è
        window.addEventListener('beforeunload', (event) => {
            if (tg?.isClosingConfirmationEnabled) {
                event.preventDefault();
                event.returnValue = '';
            }
        });

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        window.TelegramGiftsApp = {
            storage: Storage,
            telegram: tg,
            version: '1.0.0',
            generateId
        };
    </script>
</body>
</html>
